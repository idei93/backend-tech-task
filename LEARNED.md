# LEARNED — Beanie ODM

## Засвоєно в процесі виконання

- **Документні моделі з типізацією:** Beanie обгортає Motor з Pydantic моделями, надаючи повну валідацію та автодоповнення IDE
- **Декларативні індекси:** Індекси оголошуються безпосередньо в моделях через `Indexed()`, автоматично створюються при ініціалізації
- **Ініціалізація є критичною:** `init_beanie()` має викликатися при старті додатку, а не на кожен запит

## Як інтегрував у рішення

- **Де використано в коді:**
  - `models.py` — визначення EventDocument з індексованими полями (event_id, user_id, occurred_at)
  - `db.py` — ініціалізація Beanie через `init_beanie()` з реєстрацією моделей
  - `analytics.py` — використання query builder для DAU, top events та retention запитів
  - `worker.py` — вставка документів через `EventDocument.insert()` з обробкою дублікатів
  - `main.py` — FastAPI lifespan для підключення/відключення Beanie

- **Конкретні приклади інтеграції:**
  - Унікальний індекс на `event_id: Indexed(UUID, unique=True)` для ідемпотентності
  - Індекси на `occurred_at` та `user_id` для швидких аналітичних запитів
  - Aggregate pipelines для `distinct()` операцій (retention аналіз)
  - Bulk insert з `ordered=False` для CSV seeding

## Плюси / Мінуси

**Плюси**

- Повна типізація на всіх етапах роботи з БД
- Автоматичне створення та управління індексами без окремих міграцій
- Менше шаблонного коду порівняно з сирим Motor/PyMongo
- Природна інтеграція з FastAPI через спільне використання Pydantic
- Валідація даних на рівні моделі перед вставкою в БД
- Пітонічний синтаксис запитів замість словників MongoDB
- Async-native підхід ідеально підходить для FastAPI

**Мінуси**

- Складні агрегації все ще потребують знання MongoDB syntax
- Менше комьюніті порівняно з PyMongo (5k vs 50k зірок GitHub)
- Результати агрегацій повертаються як dict, а не Document
- Додаткова абстракція може ускладнити дебаг складних запитів
- Потребує розуміння як ODM концептів, так і базового MongoDB
- Зміни схеми в продакшені вимагають ретельного планування

**Коли використовувати / коли уникати**

- **Використовувати, якщо:**
  - Працюєте з FastAPI або іншим async Python фреймворком
  - Потрібне автоматичне управління індексами
  - Більшість запитів є простими CRUD операціями
  - Проєкт використовує сучасний Python (3.10+) з type hints

- **Уникати, якщо:**
  - Проєкт має дуже складні MongoDB агрегації як основну логіку
  - Працюєте з legacy синхронним кодом
  - Команда не знайома з ODM концептами і немає часу на навчання
  - Потрібен доступ до всіх специфічних функцій MongoDB
  - Критична продуктивність кожної мілісекунди (overhead від ODM)
  - Проєкт не використовує Pydantic

---
